# 一. 总体架构

# 1.1 流程

# 1.2 

# 二. 概念

## 2.1 服务提供者

1. 服务注册

   服务提供者在启动的时候通过发送REST请求的方式将自己注册到EurecaServer上，同时带上自身元数据信息。 Eureca Server接收到这个REST请求之后，将元数据的信息储存在一个双层结构的Map中，第一层map的key为服务名，第二层的key为具体服务的实例名。

2. 服务续约

   注册完服务之后，服务提供者会维持一个心跳告诉Eureca Server ：“我是一个活着的健康实例”，从而防止Eureca Server的“剔除任务”从服务列表中排除该实例。 服务续约的两个重要属性

   ```properties
   eureka:
   	instance:
   		#服务续约任务的调用间隔时间，默认为30秒
   		lease-renewal-interval-in-seconds: 30
   		#服务失效的时间，默认为90秒
   		lease-expiration-duration-in-seconds: 90
   ```
   
   

## 2.2 服务消费者

1. 获取服务

   服务消费者启动的时候会发送一个REST请求给注册中心，获取已注册的服务清单。 为了性能考虑，EurecaServer会维护一份只读的服务清单来返回给 客户端，同时该缓存清单会隔三十秒刷新一次。 

   ```properties
   eureka:
   	client: 
   		#获取服务，默认为true 
   		fetch-registry: true
   		#缓存清单的更新时间，默认三十秒
   		registry-fetch-interval-seconds: 30
   ```

   

2. 调用服务

   消费者获取清单之后，就可以获得服务者的实例名和元数据信息。 Ribbon默认使用轮询的方式调用，从而实现客户端负载均衡。

3. 下线服务

   服务实例进行正常的关闭操作时，会触发一个服务下线的REST请求给Eureca Server，注册中心将该服务状态设置为下线(DOWN)，并且把下线事件传播出去。

## 2.3 服务注册中心

1. 服务同步

   同一个服务的两个实例如果注册到不同的服务中心实例上，由于服务注册中心之间互相注册为服务，所以服务中心之间会互相转发注册请求服务给集群中的其他服务注册中心，从而实现服务注册中心之间的服务同步。

2. 失效剔除

   有时候，服务实例会因为内存溢出、网络故障等不正常下线了。但是服务注册中心并没有收到“服务下线”的请求。那么为了解决这个问题，Eureca Server 在启动的时候会创建一个定时任务，默认每隔六十秒将当前清单中超时（默认九十秒）没有续约的服务剔除出去。

3. 

# 二. 机制

## 2.1 心跳机制

​		在应用启动后，节点们将会向Eureka Server发送心跳,默认周期为30秒，如果Eureka Server在多个心跳周期内没有接收到某个节点的心跳，Eureka Server将会从服务注册表中把这个服务节点移除（默认90秒）。

## 2.1 自我保护机制

​		默认情况下，如果 Eureka Server 在一定的 90s 内没有接收到某个微服务实例的心跳，会注销该实例。但是在微服务架构下服务之间通常都是跨进程调用，网络通信往往会面临着各种问题，比如微服务状态正常，网络分区故障，导致此实例被注销。

​		固定时间内大量实例被注销，可能会严重威胁整个微服务架构的可用性。为了解决这个问题，Eureka 开发了自我保护机制，那么什么是自我保护机制呢？

​		Eureka Server 在运行期间会去统计心跳失败比例在 15 分钟之内是否低于 85%，如果低于 85%，Eureka Server 即会进入自我保护机制。

​		Eureka Server 进入自我保护机制，会出现以下几种情况：

1. Eureka 不再从注册列表中移除因为长时间没收到心跳而应该过期的服务
2. Eureka 仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上(即保证当前节点依然可用
3. 当网络稳定时，当前实例新的注册信息会被同步到其它节点中

​		Eureka 自我保护机制是为了防止误杀服务而提供的一个机制。当个别客户端出现心跳失联时，则认为是客户端的问题，剔除掉客户端；当 Eureka 捕获到大量的心跳失败时，则认为可能是网络问题，进入自我保护机制；当客户端心跳恢复时，Eureka 会自动退出自我保护机制。

​		如果在保护期内刚好这个服务提供者非正常下线了，此时服务消费者就会拿到一个无效的服务实例，即会调用失败。对于这个问题需要服务消费者端要有一些容错机制，如重试，断路器等。

​		自我保护模式的设计哲学是：在不确定节点是否可用的情况下，尽可能保留节点。





## 2.1 集群数据同步

## 2.1 客户端缓存

​		Eureka Client具有缓存功能，即使所有的Eureka Server都挂掉，客户端依然可以利用缓存中的信息消费其他服务的API。

# 三. 